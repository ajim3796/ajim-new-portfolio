---
import Layout from "../../layouts/Layout.astro";
import {
  client,
  type ProjectListResponse,
  type Project,
} from "../../lib/microcms";

// ===================================
// 1. getStaticPaths: ã©ã®URLã§ãƒšãƒ¼ã‚¸ã‚’ç”Ÿæˆã™ã‚‹ã‹å®šç¾©
// ===================================
// MicroCMSã‹ã‚‰å…¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®IDã‚’å–å¾—ã—ã€é™çš„ã‚µã‚¤ãƒˆã®ãƒ‘ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
export async function getStaticPaths() {
  // APIã‹ã‚‰å…¨ãƒªã‚¹ãƒˆã‚’å–å¾—
  const response = await client.get<ProjectListResponse>({
    endpoint: "projects",
    // IDã®ã¿å–å¾—ã™ã‚‹ã“ã¨ã§é€šä¿¡é‡ã‚’å‰Šæ¸›
    queries: { fields: ["id"] },
  });

  // å–å¾—ã—ãŸIDã‚’ä½¿ã£ã¦ã€ç”Ÿæˆã™ã¹ããƒ‘ã‚¹ã®é…åˆ—ã‚’ä½œæˆã—ã¦è¿”ã™
  return response.contents.map((project) => ({
    params: { id: project.id }, // URLã®ãƒ‘ã‚¹ï¼ˆprojects/[id]ã®idéƒ¨åˆ†ï¼‰
  }));
}

// ===================================
// 2. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆéƒ¨åˆ†: ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãƒšãƒ¼ã‚¸ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
// ===================================

// getStaticPathsã§å®šç¾©ã•ã‚ŒãŸparamsï¼ˆã“ã“ã§ã¯{id}ï¼‰ã‚’propsã¨ã—ã¦å—ã‘å–ã‚Šã¾ã™
const { id } = Astro.params;

// è©²å½“IDã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’MicroCMSã‹ã‚‰å–å¾—
let project: Project | null = null;
try {
  project = await client.get<Project>({
    endpoint: "projects",
    contentId: id,
  });
} catch (error) {
  // ãƒ“ãƒ«ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®ãƒ­ã‚°
  console.error(`Project data could not be retrieved for ID: ${id}`, error);
}

// ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®å‡¦ç† (é€šå¸¸ã¯404å‡¦ç†)
if (!project) {
  // é™çš„ã‚µã‚¤ãƒˆç”Ÿæˆæ™‚ãªã®ã§ã€ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ç°¡æ˜“çš„ãªå‡¦ç†ã«ç•™ã‚ã¾ã™ã€‚
  // å®Ÿè¡Œæ™‚ï¼ˆSSR/SSGå¾Œï¼‰ã®å‹•ä½œã¯ã€åˆ¥é€”Astroã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚
  // ä¸€æ—¦ã€ã“ã“ã§ã¯nullã‚’è¿”ã—ã¾ã™ã€‚
  return null;
}
---

<Layout title={`${project.title} | åˆ¶ä½œå®Ÿç¸¾`}>
  <article class="project-detail">
    <header class="detail-header">
      <h1>{project.title}</h1>
      {/* ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ */}
      {
        project.thumbnail?.url && (
          <img
            src={project.thumbnail.url}
            alt={`${project.title}ã®ãƒ¡ã‚¤ãƒ³ç”»åƒ`}
            class="main-image"
          />
        )
      }
    </header>

    <div class="content-body">
      <p class="period">åˆ¶ä½œæœŸé–“ : {project.production_period || "-"}</p>
      {/* ã‚µã‚¤ãƒˆURLãŒã‚ã‚Œã°è¡¨ç¤º */}
      {
        project.site_url ? (
          <a
            href={project.site_url}
            target="_blank"
            rel="noopener noreferrer"
            class="cta-button"
          >
            ã‚µã‚¤ãƒˆã¯ã“ã¡ã‚‰ &rarr;
          </a>
        ) : (
          <p>ã‚µã‚¤ãƒˆã¯ç¾åœ¨å…¬é–‹ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
        )
      }
      {/* ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰URL */}
      {
        project.source_code_url && (
          <a
            href={project.source_code_url}
            target="_blank"
            rel="noopener noreferrer"
          >
            GitHubãƒªãƒã‚¸ãƒˆãƒª &rarr;
          </a>
        )
      }

      {/* ç›®çš„ */}
      <section>
        <h2>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç›®çš„</h2>
        {/* ğŸŒŸ ä¿®æ­£æ¸ˆã¿: set:htmlã‚’divã‚¿ã‚°ã«ç›´æ¥é©ç”¨ */}
        {project.purpose && <div set:html={project.purpose} />}
      </section>

      {/* æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ */}
      <section>
        <h2>ä½¿ç”¨æŠ€è¡“</h2>
        <div class="tech-stack">
          {/* technologies ãŒå­˜åœ¨ã—ã€æ–‡å­—åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰åˆ†å‰² */}
          {
            project.technologies &&
              project.technologies.map((tech) => (
                <span class="tech-tag">{tech.trim()}</span>
              ))
          }
        </div>
      </section>

      {/* èª²é¡Œã¨è§£æ±ºç­– (æœ€ã‚‚é‡è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³) */}
      <section class="solution-section">
        <h2>èª²é¡Œã¨è§£æ±ºç­–</h2>
        {/* ğŸŒŸ ä¿®æ­£æ¸ˆã¿: set:htmlã‚’divã‚¿ã‚°ã«ç›´æ¥é©ç”¨ */}
        {
          project.problem_solution && (
            <div set:html={project.problem_solution} />
          )
        }
      </section>
    </div>
  </article>

  <div class="button-container">
    <a href="/" class="button">Home</a>
    <a href="/projects" class="button">Projects</a>
  </div>
</Layout>

<style>
  .main-image {
    width: auto;
    max-height: 500px;
    min-width: 200px;
    box-shadow: #929292 0px 4px 16px;
  }
  .content-body {
    display: flex;
    flex-direction: column;
  }
  .tech-tag {
    display: inline-block;
    background-color: #f0f0f0;
    color: #333;
    padding: 0.4rem 0.8rem;
    margin: 0.2rem;
    border-radius: 4px;
    font-size: 0.9rem;
  }
  .button-container {
    display: flex;
    margin-top: 4rem;
    justify-content: space-between;
  }
  .button {
    display: inline-block;
    padding: 0.8rem 2rem;
    background-color: #0070f3;
    color: white;
    font-weight: bold;
    text-decoration: none;
    border-radius: 4px;
  }
</style>
